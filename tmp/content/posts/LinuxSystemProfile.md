---
title: Linux System Profile
date: "2020-07-24"
summary: "Linux系统调优"
---

在Linux系统上对应用程序进行性能调优是很常见的，本文介绍在应用程序出现性能问题时，如何定位问题、解决问题。

## 基础

### 资源

性能的表现永远和资源相关。如果我们拥有无限内存超高性能的硬件，那性能问题就不复存在。

当出现性能问题时，一定是资源出现了下面某种情况：

* 到达了瓶颈/极限
* 没有被充分利用
* 出错了

普通计算机一般包括下列资源：

* 寄存器
* CPU（缓存、Core、PC程序计数器等）
* IO设备（磁盘、网卡等）
* 内存

其中，寄存器一般由计算机自己控制，不太会出现问题。后三者是常见的性能瓶颈所在。

### 指标

指标用来衡量系统的表现，也就是怎么样算系统表现好，怎么样算系统表现差。

系统的指标从各个维度（可用性，性能等）可以有很多，和性能相关的主要是：

* 吞吐量：一般用QPS衡量，即系统每秒能处理的请求数
* 时延：系统处理一个请求所消耗的时间

## 系统状态变化

单线程，无IO，同步请求

系统表现只与CPU相关：

$$t(x)=\frac 1x$$

$$qps(x)=x$$

单线程，有IO，同步请求

系统表现与CPU和IO相关

$$t(x,y)=\frac{1}{x} + \frac{1}{y}$$

$$qps(x, y)=\frac{xy}{(x+y)}$$

多线程，无IO，无共享资源

## 定位

### 方法论

USE Method

对每个资源(Resource)，检查其利用率(Utilization),饱和度(Saturation)以及错误(Error)

* 资源：所有的服务器硬件组件（CPU，disk等）和软件资源(锁，队列等)

* 利用率：资源忙于工作的平均时间，或者，资源被使用的比例
* 饱和度：资源距离满负荷工作的程度，通常是在队列中的
* 错误：错误事件的次数

通常用下面的item定义：

* 利用率：在一段时间内的百分比，例如“CPU达到了50%利用率“
* 饱和度：队列的长度
* 错误：标量数据

资源列表：

* CPU：sockets，cores，hardware threads (virtual CPUs)
* Memory：capacity
* Storage devices：I/O, capacity
* Controllers：storage, network cards

USE方法对于在高利用率和高饱和度下会导致性能退化从而出现瓶颈的资源最为有效。

指标包括：

| 资源       | 类型   | 指标                        |
| ---------- | ------ | --------------------------- |
| CPU        | 利用率 | CPU利用率                   |
| CPU        | 饱和度 | 运行的队列长度或是调度延时  |
| 内存容量   | 利用率 | 可用的内存                  |
| 内存容量   | 饱和度 | 匿名换页，或thread swapping |
| 网络接口   | 利用率 | RX/TX吞吐/最大带宽          |
| 存储设备IO | 利用率 | 设备busy百分比              |
| 存储设备IO | 饱和度 | 等待队列的长度              |
| 存储设备IO | 错误   | 设备错误                    |

有些软件资源也可以用相似的方法分析，例如：

* 互斥锁：利用率可以定义为锁被持有的时间；饱和度是等待锁的线程队列长度
* 线程池：利用率可以定义为线程忙于工作的时间；饱和度是等待被线程池处理的请求数量
* 文件描述符容量：利用率可以定义为当前文件描述符的使用数量，饱和度可以定义为等待被分配的描述符数量

对指标的解读：

* 利用率：100%的利用率通常是瓶颈所在。高利用率可能出于许多原因开始成为系统的瓶颈：
  * 当利用率是通过较长的时间衡量，长期的利用率较低可能掩盖了短期较高的利用率
* 饱和度：任何程度的饱和度都可能是问题（非零）；这可以通过队列的长度，或是等待队列的时间来衡量
* 错误：非零的错误数量就需要重视，尤其是随着性能变差它们变得更多时



### 工具

## 解决

