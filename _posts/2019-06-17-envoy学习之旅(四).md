---
layout: posts
---
本周对envoy的介绍文档仔细的阅读了一遍。在此将笔记记录如下。  

## What is Envoy 
Envoy是一个L7的代理以及通讯总线，被用于大规模现代SOA架构。  

Envoy认为:  
**网络对应用应当是透明的。当网络和应用发生了问题，应该可以很简单就定位到问题的源头**  

Envoy有下列特性：  

**Out of process architecture**：Envoy是一个自包含进程，与应用服务一同启动。这有两大好处：  
* 与任意应用语言都能工作  
* 由于不是库的形式，Envoy可以快速部署和升级  

**现代C++11代码**: 既有速度又有生产力  

**L3/L4过滤架构**: Envoy在其核心是一个L3/L4的网络代理。可插入的`filter chain`机制使过滤器能被写出来用于完成不同的TCP代理任务并插入到主服务器中。  

**HTTP过滤架构**：Envoy提供一层额外的HTPP过滤层。  

**HTTP L7 路由**: 在HTTP模式下，Envoy支持一个路由子系统。该系统能基于路径、内容和运行时值等路由和重定向请求。  

**多种支持**： gRPC,MongDB L7, Dynamo DB L7等  

**服务发现和动态配置**： Envoy可选的提供了动态配置API层。该层允许Envoy动态的更新：后端`cluster`中的`host`,后端`clusters`,HTTP 路由，监听 sockets等  

**健康检查**： 构建Envoy网格的建议方式是将服务发现作为最终一致的过程。Envoy包含一个健康检查子系统，能可选的主动检查上游服务cluster的健康情况。  
**高级负载均衡**:  

## Architecture overview
### Terminoogy
**Host**: 能进行网络通信的一个实体(移动手机上的应用，服务器等)。一台硬件上可能有多个Host  

**Downstream**: 一个下游host连接到Envoy，发送请求并接收回应  

**Upstream**: 一个上游host从Envoy接收连接和请求并作出回应  

**Listener**: 一个Listener是一个命名了的网络位置(例如端口，Unix域socket等)，该位置可以被下游客户端连接。Envoy会暴露一个或多个listener供下游host连接  

**Cluster**: 一个cluster是逻辑上相似的一组上游host，Envoy连接到这些host。Envoy通过服务发现找到cluster中的成员，通过健康检查判断该成员是否健康，通过负载均衡策略路由请求  

**Mesh**: 一组协调起来提供一致的网络拓扑的host。在本文档中，"Envoy mesh"是指一组分布式系统中组成了消息传递基础的Envoy代理  

**Runtime configuration**: 带外实时配置系统，与Envoy一同部署  

### Thread model
Envoy使用单进程多线程架构。单个*master*线程控制偶尔发生的协调任务，一些*worker*线程处理监听、过滤和转发任务。一旦一个连接被一个listener接受，该连接的剩余生命就和该worker线程绑定了。这使得Envoy大部分是单线程的(`embarrassingly parallel`),一小部分更复杂的代码处理worker线程之间的协调。通常Envoy是完全非阻塞的，大部分情况下建议工作线程的数量和硬件线程的数量一致。  

### Listeners
Envoy配置支持在一个进程中设置任意数量的listener。通常我们建议不管设置的listener有多少，每个机器都设置一个Envoy。  

每个listener都通过一些网络层(L3/L4)过滤器独立的配置。当listener接收到了一个新的连接，配置好的本地连接过滤器堆栈将会被实例化并开始处理一系列的事件。  

Listener也可以配置一些listener过滤器。该过滤器在网络层过滤器之前被使用，可以操纵连接的元数据。通常这是为了影响连接后续怎么被过滤器或者cluster处理。  

Listener也可以通过`listener discovery service`(LDS)动态的获取。  

### Listener filters
Listener filters的主要目的是使得以后增加系统集成函数更简单(通过不改变Envoy的核心功能)。  

Listener filters的API相对简单因为最终是对新接受的sockets进行操作。  

### Network(L3/L4) filters
网络层过滤器是Envoy连接处理的核心。有三种不同种类的网络过滤器：  
* 读：当Envoy从下游连接收到信息时，读过滤器被调用  
* 写：当Envoy要发送数据给下游连接时，写过滤器被调用  
* 读/写：不管Envoy收到数据还是发送数据，读/写过滤器都会被调用  

网络层过滤器的API相对简单，因为最终过滤器对原始字节和一小部分的连接事件(例如TLS握手，连接断开等)进行操作。  

### HTTP connection management
Envoy有一个内置的网络层过滤器`HTTP connection manager`。该过滤器将原始字节转化为HTTP层的信息和事件。它也处理所有HTTP连接和请求共同的功能。  

#### HTTP protocols
Envoy的`HTTP connection manager`原生支持HTTP/1.1,WebSockets和HTTP/2。Envoy设计为最先支持HTTP/2复用代理。HTTP/2的术语被用来描述系统组件。例如，HTTP请求和响应在流上发生。一个`codec`API被使用来转化协议。以HTTP/1.1为例，`codec`将协议的序列/管道能力转化为像HTTP/2一样(对更高层来说)。  

#### HTTP header sanitizing  
`HTTP connection manager`出于安全考虑提供许多不同的首部净化措施。  

#### Route table configuration
每个`HTTP connection manager`过滤器有一个关联的路由表。路由表可以是静态的，也可以通过`RDS`API动态指定。  

#### Retry plugin configuration

