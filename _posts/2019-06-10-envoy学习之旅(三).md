---
layout: posts
---
上回修改了docker容器以及app实际监听的端口号。现在app在容器内部的8080端口号上监听，而我们访问则通过容器发布的8000端口号访问。接下去终于进入了正题，即使用envoy来代理对该app的访问。  

## 实现过程
首先小小的修改一下`docker-compose.yaml`文件。在其中`service`下面添加一个选项`volumes`,如下所示  
```
volumes:
    - ./service-envoy.yaml:/etc/service-envoy.yaml
```
这句话的意思是把当前目录下的配置文件`service-envoy.yaml`挂在到容器中的`/etc`目录下。

然后把`expose`和`ports`选项改成下面的样子：  
```
expose:
    - "80"
ports:
    - "8000:80"
```

至于为什么要改成这样，在后面马上会提到。

接下去修改一下启动脚本，其中添加了`envoy`的启动，如下所示：  
```
#!/bin/sh
python3 /code/hello_world_service.py &
envoy -c /etc/service-envoy.yaml
```

最后，最关键的就是`service-envoy.yaml`文件了。`service-envoy.yaml`文件和官网提供的例子很像，其内容如下：  
```
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 80
    filter_chains:
    - filters:
      - name: envoy.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.config.filter.network.http_connection_manager.v2.HttpConnectionManager
          codec_type: auto
          stat_prefix: ingress_http
          route_config:
            name: local_route
            virtual_hosts:
            - name: service
              domains:
              - "*"
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: local_service
          http_filters:
          - name: envoy.router
            typed_config: {}
  clusters:
  - name: local_service
    connect_timeout: 0.25s
    type: strict_dns
    lb_policy: round_robin
    load_assignment:
      cluster_name: local_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 0.0.0.0
                port_value: 8080
admin:
  access_log_path: "/dev/null"
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 8081
```  
这里的选项非常之多，我这里暂且不做详细的解释，在下面我阅读了envoy的官方文档，并将其中涉及到的重要选项列举一下。  

这里我只大概说一下文件所表达的意思。首先，`envoy`根据该文件创建了一个`listener`和`cluster`,`listener`监听在端口号80上,`cluster`则监听在在端口号8080上。`listener`根据过滤器的配置过滤、转发请求。这里的`listener`将前缀为`/`的所有请求转发给名字叫做`local_service`的`cluster`,由`cluster`再给出回应。  

这里尤其要注意的是端口号。此处`listener`的监听端口号是容器内部的端口号。因此在做端口映射时，主机端口应当映射到该端口，也因此`docker-compose.yaml`中的文件中的端口相关选项做了修改。`cluster`的端口号应当是业务逻辑，即app中的监听端口号。  

## 相关envoy选项含义  
