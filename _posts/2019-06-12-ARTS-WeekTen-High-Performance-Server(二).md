---
layout: posts
---
接下去介绍高性能服务器设计的最后两个因素。  

## Memory allocation  
内存分配是制约服务器性能的一大瓶颈。  

作者提出了三种方法：  
1. 预分配内存。动态分配内存的好处是不会浪费空间，然而需要消耗时间。如果有些内存分配是必需的，在程序运行前就可以确定的，则可以进行预分配，即便这样会浪费一些内存。  
2. 使用`look aside`列表。其基本思想是对于要释放的对象不立即释放，而是将它加入到一个列表中。这样，，多个私有列表来保持较低的分配开支如果短时间内又需要用到该对象，则不重新分配而是从链表中获取即可。对于`look aside`列表的使用，显然不能让其无限制变多，因此作者提出采用新旧列表的方法，既避免了过多的锁争用，又能释放无用对象的内存。  
3. 在分配内存时会出现锁争用的情况，即使使用了`look aside`列表也是如此。该情况是内存分配消耗最大的情况。为了避免该情况，可以维护多个私有的`look aside`列表。例如，可以给每个线程分配一个该列表，这样就避免了锁争用。或者是一个处理器一个列表。必要时也可以用一个共享列表，多个私有列表来保持较低的分配开支  

## Lock Contention
这一块由于接触的太少，我还看不太懂，暂时就先不翻译了。  

## Other Stuff
作者提出了一些其他的问题  
* 对于较大或较小的请求你的存储子系统表现如何？序列化或随机化请求呢？`read-ahead`和`write-behind`工作情况如何？  
* 你正在使用的网络协议效率如何？有没有你能设置的参数或者标志能使其工作的更好？有没有像`TCP_CORK`,`MSG_PUSH`或是Nagle这样的技巧使其避免较小的信息？  
* 你的系统支持离散/聚合IO(readv/writev)吗？使用该技术能提高性能并避免使用缓冲区的链的痛苦  
* 页的大小是多少？缓存行的大小是多少？在这些大小上对齐值得吗？系统调用或者上下文切换比起其他东西的开销来说如何？  
* 你的读/写锁会饥饿吗？你的事件有惊群效应吗？  

问题有很多，这些问题都是值得思考的。应当对于不同的平台都了解上面的东西，哪怕只是经验值。